<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<!-- Generated by Teracle sqlMapper TOOL -->
<sqlMap namespace="tr_member">

    <!-- QUERIES  -->

    <insert id="insert">
        INSERT INTO
            `tr_member`
            (`mb_type`,`mb_level`,`mb_email`,`mb_pass`,`mb_name`,`mb_goal`,`mb_photo`,`mb_photo_thumb`,`mb_date`,`mb_last`,`mb_ip`)
        VALUES
            (#mb_type#,#mb_level#,#mb_email#,password(#mb_pass#),#mb_name#,#mb_goal#,#mb_photo#,#mb_photo_thumb#,NOW(),NOW(),#mb_ip#)
        <selectKey resultClass="int" keyProperty="idx">
            SELECT LAST_INSERT_ID() AS idx;
        </selectKey>

    </insert>

    <update id="update_part">
        UPDATE
            `tr_member`
        SET
        <dynamic prepend="">
            <isPropertyAvailable property="mb_type" prepend=",">
                `mb_type` = #mb_type#
            </isPropertyAvailable>
            <isPropertyAvailable property="mb_level" prepend=",">
                `mb_level` = #mb_level#
            </isPropertyAvailable>
            <isPropertyAvailable property="mb_email" prepend=",">
                `mb_email` = #mb_email#
            </isPropertyAvailable>

            <isPropertyAvailable property="mb_pass" prepend=",">
                `mb_pass` = password(#mb_pass#)
            </isPropertyAvailable>

            <isPropertyAvailable property="mb_name" prepend=",">
                `mb_name` = #mb_name#
            </isPropertyAvailable>

            <isPropertyAvailable property="mb_goal" prepend=",">
                `mb_goal` = #mb_goal#
            </isPropertyAvailable>

            <isPropertyAvailable property="mb_photo" prepend=",">
                `mb_photo` = #mb_photo#
            </isPropertyAvailable>

            <isPropertyAvailable property="mb_photo_thumb" prepend=",">
                `mb_photo_thumb` = #mb_photo_thumb#
            </isPropertyAvailable>

            <isPropertyAvailable property="mb_ip" prepend=",">
                `mb_ip` = #mb_ip#
            </isPropertyAvailable>

        </dynamic>
        ,`mb_last` = NOW()
        WHERE
        `mb_idx` = #mb_idx#
    </update>

    <delete id="delete">
        DELETE FROM
            `tr_member`
        WHERE
            `mb_idx` = #mb_idx#
    </delete>


    <!-- 검색절이 있을 때는 dynamic을 이용해서 재구성 할 것 -->
    <select id="select_cnt" parameterClass="array" resultMap="hashMap">
        SELECT
            COUNT(`mb_idx`) AS cnt
        FROM
            `tr_member`
        WHERE
            1
        <dynamic prepend="">
            <isNotEmpty property="mb_email">
                AND `mb_email` LIKE CONCAT('%', #mb_email# , '%')
            </isNotEmpty>
            <isNotEmpty property="mb_name">
                AND `mb_name` LIKE CONCAT('%', #mb_name# , '%')
            </isNotEmpty>
            <isNotEmpty property="mb_level">
                AND `mb_level` = #mb_level#
            </isNotEmpty>
        </dynamic>
        ORDER BY
        `mb_idx` DESC;
    </select>

    <select id="select_search" parameterClass="array" resultMap="hashMap">
        SELECT
            *
        FROM
        `tr_member`
        WHERE
        1
        <dynamic prepend="">
            <isNotEmpty property="mb_email">
                AND `mb_email` LIKE CONCAT('%', #mb_email# , '%')
            </isNotEmpty>
            <isNotEmpty property="mb_name">
                AND `mb_name` LIKE CONCAT('%', #mb_name# , '%')
            </isNotEmpty>
            <isNotEmpty property="mb_level">
                AND `mb_level` = #mb_level#
            </isNotEmpty>
        </dynamic>
        ORDER BY
        `mb_idx` DESC
        LIMIT $limit_start$, $page_row$
    </select>

    <select id="select_getMember" parameterClass="array" resultMap="hashMap">
        SELECT
            *
        FROM
            `tr_member`
        WHERE
            mb_idx=#mb_idx#
    </select>

    <select id="select_one" parameterClass="array" resultMap="hashMap">
        SELECT
            *
        FROM
            `tr_member`
        WHERE
            mb_idx=#mb_idx#
    </select>

    <select id="select_checkLogin_mb_idx" parameterClass="array" resultMap="hashMap">
        SELECT
        `mb_idx`
        FROM
        `tr_member`
        WHERE
        mb_idx = #mb_idx#
        and ( mb_pass = password(#mb_pass#) or mb_pass = old_password(#mb_pass#) )
    </select>


    <select id="select_checkLogin" parameterClass="array" resultMap="hashMap">
        SELECT
            `mb_idx`
        FROM
            `tr_member`
        WHERE
            mb_email = #mb_email#
            and mb_pass = password(#mb_pass#)
    </select>

    <select id="select_checkLoginIdx" parameterClass="array" resultMap="hashMap">
        SELECT
            `mb_idx`
        FROM
            `tr_member`
        WHERE
            mb_idx = #mb_idx#
            and mb_pass = password(#mb_pass#)
    </select>

    <select id="select_isMember" parameterClass="array" resultMap="hashMap">
        SELECT
        `mb_idx`
        FROM
        `tr_member`
        WHERE
        mb_email = #mb_email#
    </select>

    <select id="select_password" parameterClass="array" resultMap="hashMap">
        SELECT
            password(#mb_pass#) AS mb_pass
    </select>


    <select id="select_checkMemberOut" parameterClass="array" resultMap="hashMap">
        SELECT
            `mb_idx`
        FROM
            `tr_member`
        WHERE
            mb_idx = #mb_idx#
            and mb_email = #mb_email#
            and mb_pass = password(#mb_pass#)
    </select>


    <insert id="insert_MemberOut">
        INSERT INTO
        `tr_member_out`
            (`mb_idx`,`mb_type`,`mb_email`,`mb_pass`,`mb_name`,`mb_goal`,`mb_photo`,`mb_photo_thumb`,`mb_date`,`mb_last`,`mb_ip`)
        VALUES
            (#mb_idx#,#mb_type#,#mb_email#,password(#mb_pass#),#mb_name#,#mb_goal#,#mb_photo#,#mb_photo_thumb#,NOW(),NOW(),#mb_ip#)
    </insert>

    <select id="select_find_password" parameterClass="array" resultMap="hashMap">
        SELECT
            `mb_idx`
        FROM
            `tr_member`
        WHERE
            mb_email = #mb_email#
            and mb_tel = #mb_tel#
    </select>


    <select id="select_nick_check" parameterClass="array" resultMap="hashMap">
        SELECT
            `mb_idx`
        FROM
            `tr_member`
        WHERE
            mb_name = #mb_name#
    </select>

    <select id="select_mb_email" parameterClass="array" resultMap="hashMap">
        SELECT
            *
        FROM
            `tr_member`
        WHERE
            mb_email = #mb_email#
    </select>


</sqlMap>
            